<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Project Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /*
         * By making the body a flex container that fills the full height of the html tag,
         * we create a more stable layout for mobile devices, especially when the
         * on-screen keyboard appears.
        */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .aurora-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(ellipse at top, #1e293b, #0f172a 70%),
                        radial-gradient(ellipse at bottom, #334155, #0f172a 70%);
            animation: aurora 20s linear infinite;
        }
        @keyframes aurora {
            0% { background-position: 0% 50%, 0% 50%; }
            50% { background-position: 100% 50%, 100% 50%; }
            100% { background-position: 0% 50%, 0% 50%; }
        }
        #chat-window {
            scroll-behavior: smooth;
        }
        .chat-bubble {
            animation: pop-in 0.3s ease-out;
        }
        @keyframes pop-in {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
    <!-- NEW: Dynamically load the knowledge base with a cache-busting query -->
    <script>
        const knowledgeScript = document.createElement('script');
        knowledgeScript.src = `/knowledge.js?v=${Date.now()}`;
        document.head.appendChild(knowledgeScript);
    </script>
</head>
<body class="bg-gray-900 text-white">
    <div class="aurora-background"></div>

    <!-- This main container now grows to fill the body, rather than using a fixed screen height -->
    <div class="container mx-auto flex flex-col flex-grow p-4 relative z-10">
        <!-- Header is set to not shrink -->
        <header class="text-center py-4 flex-shrink-0">
            <h1 class="text-4xl font-bold mb-1" style="color: #FFD700;">AI Project Chatbot</h1>
            <p class="text-md text-gray-400">Ask me anything about the Breakout game project!</p>
        </header>

        <!-- 
          The chat area now uses min-h-0, a key fix that allows a scrolling element (the chat window) 
          to work correctly inside a flex container on small screens.
        -->
        <div class="flex-grow bg-gray-800/50 backdrop-blur-sm rounded-lg border-2 border-gray-700 flex flex-col min-h-0">
            <!-- The chat window itself grows to fill the space and scrolls as needed -->
            <div id="chat-window" class="flex-grow p-4 space-y-4 overflow-y-auto">
                <!-- Chat messages will be appended here -->
            </div>
            <!-- The input area is set to not shrink, keeping its size -->
            <div class="p-4 border-t-2 border-gray-700 flex-shrink-0">
                <div class="flex items-center bg-gray-900 rounded-lg">
                    <input type="text" id="chat-input" placeholder="Ask a question..." class="flex-grow bg-transparent p-3 text-white focus:outline-none">
                    <button id="send-button" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-5 m-1 rounded-lg transition-colors">
                        Send
                    </button>
                </div>
            </div>
        </div>
        <!-- The footer link is also set to not shrink -->
        <div class="text-center mt-4 flex-shrink-0">
            <a href="/index.html" class="text-gray-400 hover:text-yellow-400 transition-colors">← Back to Home</a>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatWindow = document.getElementById('chat-window');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');

            const addMessage = (sender, text) => {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-bubble', 'max-w-xl', 'p-3', 'rounded-lg');

                if (sender === 'user') {
                    messageDiv.classList.add('bg-yellow-500', 'text-gray-900', 'self-end', 'ml-auto');
                } else {
                    messageDiv.classList.add('bg-gray-700', 'text-white', 'self-start', 'mr-auto');
                }
                
                messageDiv.textContent = text;
                chatWindow.appendChild(messageDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            };
            
            const showTypingIndicator = () => {
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typing-indicator';
                typingDiv.classList.add('chat-bubble', 'bg-gray-700', 'text-white', 'self-start', 'mr-auto', 'p-3', 'rounded-lg');
                typingDiv.innerHTML = '<span class="animate-pulse">● ● ●</span>';
                chatWindow.appendChild(typingDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            };

            const removeTypingIndicator = () => {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    indicator.remove();
                }
            };

            const getAIResponse = async (userMessage) => {
                showTypingIndicator();

                // Check that KNOWLEDGE_BASE is available before using it.
                const context = typeof KNOWLEDGE_BASE !== 'undefined' ? KNOWLEDGE_BASE : '';

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMessage, context: context })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const aiText = result.reply;
                    
                    removeTypingIndicator();
                    addMessage('ai', aiText);

                } catch (error) {
                    removeTypingIndicator();
                    addMessage('ai', "Sorry, I'm having trouble connecting right now. Please try again later.");
                    console.error("AI Error:", error);
                }
            };

            const handleSend = () => {
                const message = chatInput.value.trim();
                if (message) {
                    addMessage('user', message);
                    chatInput.value = '';
                    getAIResponse(message);
                }
            };

            sendButton.addEventListener('click', handleSend);
            chatInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    handleSend();
                }
            });

            addMessage('ai', "Hello! I'm an AI agent. Feel free to ask me anything about how the Breakout game was made.");
        });
    </script>
</body>
</html>
